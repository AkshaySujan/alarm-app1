name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install & test backend
        working-directory: backend
        run: |
          npm ci
          npm test --if-present

  integration:
    runs-on: ubuntu-latest
    needs: test-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug — show folders
        run: ls -R .

      - name: Build services via Docker Compose
        working-directory: ./
        run: docker compose up --build -d

      - name: Wait for backend HTTP
        working-directory: ./
        run: |
          URL="http://localhost:3000/api/alarms"
          echo "Waiting for backend… $URL"
          for i in {1..30}; do
            if curl -sSf "$URL" > /dev/null; then
              echo "Backend is up!"
              exit 0
            fi
            echo "Retrying ($i/30)…"
            sleep 2
          done
          echo "❌ ERROR: Backend did not start"
          docker compose logs --tail=200
          exit 1

      - name: Smoke Test — GET & POST
        working-directory: ./
        run: |
          echo "GET /api/alarms"
          curl -i http://localhost:3000/api/alarms

          echo "POST /api/alarms"
          curl -i -X POST http://localhost:3000/api/alarms \
            -H "Content-Type: application/json" \
            -d '{"title":"CI Test", "timeISO":"2025-12-06T07:00:00.000Z"}'

      - name: Shutdown services
        if: always()
        working-directory: ./
        run: docker compose down --volumes --remove-orphans
