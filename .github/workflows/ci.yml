name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install & run backend tests (if package.json exists)
        working-directory: ./backend
        run: |
          if [ -f package.json ]; then
            npm ci
            if npm run | grep -q "test"; then
              npm test
            else
              echo "No test script in package.json — skipping npm test"
            fi
          else
            echo "backend/package.json not found — skipping tests"
          fi

  integration:
    needs: test-backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show docker / compose versions
        run: |
          docker --version || true
          docker compose version || true

      - name: Build docker images with docker compose
        run: |
          # run docker compose from repo root; adjust file name if your compose file is elsewhere
          docker compose up --build -d

      - name: Wait for backend HTTP to become healthy
        run: |
          URL="http://localhost:4000/api/alarms"
          echo "Waiting for $URL to respond (timeout ~60s)..."
          for i in $(seq 1 30); do
            if curl -sSf "$URL" > /dev/null 2>&1; then
              echo "OK: $URL is responding"
              break
            fi
            echo -n "."
            sleep 2
          done
          if ! curl -sSf "$URL" > /dev/null 2>&1; then
            echo "ERROR: $URL did not respond in time" >&2
            docker compose ps
            docker compose logs --tail 100
            exit 1
          fi

      - name: Run API smoke tests (GET + POST)
        env:
          URL_BASE: "http://localhost:4000"
        run: |
          set -e
          echo "GET /api/alarms"
          HTTP_CODE_GET=$(curl -s -o /dev/null -w "%{http_code}" "$URL_BASE/api/alarms")
          echo "GET returned $HTTP_CODE_GET"
          if [ "$HTTP_CODE_GET" -ne 200 ]; then
            echo "GET /api/alarms failed with $HTTP_CODE_GET" >&2
            docker compose logs --tail 200
            exit 1
          fi

          echo "POST /api/alarms (create)"
          PAYLOAD='{"title":"CI Test","timeISO":"2025-12-06T07:00:00.000Z"}'
          HTTP_CODE_POST=$(curl -s -o /tmp/resp.json -w "%{http_code}" -X POST "$URL_BASE/api/alarms" -H "Content-Type: application/json" -d "$PAYLOAD")
          echo "POST returned $HTTP_CODE_POST"
          if [ "$HTTP_CODE_POST" -ne 201 ]; then
            echo "POST /api/alarms failed; showing last logs" >&2
            docker compose logs --tail 200
            cat /tmp/resp.json || true
            exit 1
          fi
          echo "POST success. Response body:"
          cat /tmp/resp.json

      - name: Tear down compose services
        if: always()
        run: |
          docker compose down --volumes --remove-orphans
